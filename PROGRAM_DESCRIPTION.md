# Документация по спектральному комплексу

## Введение
Программа предназначена для автоматизированного анализа временных рядов, полученных
в двух частотных диапазонах (LF и HF) при разных температурах и значениях
магнитного поля. Цель обработки — восстановить резонансные частоты и времена
затухания мод, используя доступные теоретические оценки и минимизируя влияние
шума. Настоящий документ описывает полный алгоритм, применяемые методы и функции,
а также дополнительные элементы инфраструктуры.

## Глава 1. Алгоритм обработки
Алгоритм реализован в модуле `spectral_pipeline` и запускается через CLI
(`find_freqs_and_visualize.py` или `spectral_pipeline.cli`). Ниже приведена
последовательность действий с указанием ключевых функций и условий перехода.

### 1.1. Инициализация
1. Функция `spectral_pipeline.cli.main` принимает путь к каталогу с данными,
   опциями визуализации и экспортом. Она создаёт объект `ProcessingConfig`,
   содержащий параметры поиска пиков (границы частот, допуски по времени и т. д.).
2. `main` вызывает `load_records`, который перечисляет файлы `*.dat`, группирует
   их по температуре и полю и формирует сырые структуры `RawRecord`.

### 1.2. Формирование наборов данных
1. Для каждой пары LF/HF `load_records` строит объект `DataSet`:
   - нормализует временную сетку и значения сигнала;
   - при необходимости усекает сигнал после первого минимума для подавления
     отражений;
   - загружает файлы первого приближения `H_<H>.npy` или `T_<T>.npy`, если они
     присутствуют в папке.
2. Функция `_load_guess` ожидает пять строк в файле: идентификатор оси,
   частоты HF, частоты LF, времена затухания HF и LF (в наносекундах). Значения
   времени конвертируются в секунды и сохраняются в `DataSet.initial_guess` как
   `freq_guess` и `tau_guess`.

### 1.3. Обработка каждой пары (`process_pair`)
1. **Подготовка сигналов**: временные ряды LF и HF центрируются, при наличии
   теории в структуре `DataSet` фиксируется набор допустимых частот и времен.
2. **ESPRIT-анализ** (`_esprit_freqs_and_decay`):
   - строятся ганкелевы матрицы с размером окна `NS`;
   - вызывается `multichannel_esprit`, возвращающая комплексные собственные
     значения и оценки частоты/затухания;
   - отрицательные или слишком малые времена затухания отбрасываются, логируется
     количество исключённых компонент.
3. **Фильтрация кандидатов** (`_search_candidates`):
   - частотные оценки делятся на LF/HF зоны;
   - если теоретический файл присутствует, диапазоны ограничиваются
     `f_guess ± 5 ГГц` и `tau_guess · (1 ± 0.2)`; иначе применяется общий диапазон
     из конфигурации;
   - при отсутствии HF‑кандидатов окно расширяется до ±10 ГГц вокруг
     `f2_guess` и фильтрация повторяется.
4. **Резервный поиск** (`_fallback_peak`):
   - если ESPRIT не дал кандидатов, выполняется FFT‑поиск в ограниченном
     диапазоне; пороги `height`/`prominence` понижаются при каждой итерации;
   - при попадании пика на границу диапазон расширяется не более двух раз,
     избегая зацикливания.
5. **Формирование списков LF/HF**: к ESPRIT‑кандидатам добавляются пики FFT и
   теоретические значения. Каждый кандидат — кортеж `(frequency, tau, weight)`,
   где вес отражает доверие к источнику (теория, ESPRIT, FFT).
6. **Перебор комбинаций** (`fit_pair`):
   - выполняется вложенный цикл по LF/HF кандидатам, несовместимые комбинации
     (выходящие за допустимые диапазоны) пропускаются;
   - для каждого сочетания инициируется нелинейная подгонка.
7. **Оценка результата**: наилучшая комбинация выбирается по минимальному значению
   функции стоимости при ограничении `MAX_COST`. В случае неудачи фиксируется
   предупреждение, а пара помечается как «не обработана».

### 1.4. Обработка только LF (`process_lf_only`)
Если HF‑файл отсутствует или выходит за пределы измерения, вызывается
`process_lf_only`. Алгоритм совпадает с описанным выше, но HF‑кандидаты формируются
из подгонки остатка LF-сигнала и теоретических оценок. Окончательный результат
содержит только одну частоту и время затухания.

### 1.5. Визуализация и экспорт
1. После обработки всех пар `main` передаёт результаты в функции из
   `spectral_pipeline.plotting` для построения отчётов. Доступно два режима:
   `visualize_stacked` (со спектрами) и `visualize_without_spectra`.
2. `export_freq_tables` преобразует результаты в таблицы «температура × поле» и
   сохраняет Excel‑файл с частотами и временами затухания.

## Глава 2. Используемые методы и математические основания
В этом разделе описаны основные алгоритмы анализа сигналов.

### 2.1. Модель сигнала
Каждый сигнал моделируется как сумма двух затухающих косинусоид:
\[
  s(t) = \sum_{k=1}^{2} A_k \exp\!\left(-\frac{t}{\tau_k}\right)
            \cos(2\pi f_k t + \varphi_k) + C.
\]
Цель аппроксимации — оценить \( f_k \) и \( \tau_k \) при минимизации
\( \|s_{\text{meas}} - s(t)\|_2^2 \) с весовой функцией, уменьшающей вклад
хвоста (веса спадают экспоненциально).

### 2.2. Метод ESPRIT
`multichannel_esprit` применяет алгоритм SVD‑разложения на ганкелевых матрицах,
что позволяет получить собственные значения
\( z_k = e^{(\alpha_k + i 2\pi f_k)\Delta t} \). Здесь
\( \alpha_k = -1/\tau_k \). Оценка частоты выполняется как
\( f_k = \frac{\arg(z_k)}{2\pi \Delta t} \), время затухания —
\( \tau_k = -\Delta t / \ln|z_k| \). Компоненты с \( \tau_k \le 0 \) или слишком
большими значениями отбрасываются.

### 2.3. Спектральные оценки и резервные методы
- **FFT и поиск пиков**: функция `_fft_spectrum` вычисляет модуль FFT. Затем
  `_peak_in_band` вызывает `scipy.signal.find_peaks` с адаптивными порогами.
  При отсутствии пиков диапазон расширяется, а пороги снижаются по геометрической
  прогрессии.
- **Burg‑AR**: `_fallback_peak` использует метод Бюрга для оценки спектра по
  авторегрессионной модели порядка `AR_ORDER`. Пик в диапазоне поиска даёт
  кандидатную частоту.
- **Метод Уэлча**: вычисляет усреднённую периодограмму, обеспечивая устойчивость
  при наличии шума. Времена затухания получают через перебор подходящих \( \tau \),
  минимизирующих остаток между оценкой и теорией.
- **Усреднённый FFT**: для повышения устойчивости берётся среднее между FFT на
  полном сигнале и усечённом окне.

### 2.4. Нелинейная аппроксимация
Функция `fit_pair` формирует вектор параметров
\( \theta = (A_1, A_2, f_1, f_2, \tau_1, \tau_2, \varphi_1, \varphi_2, C) \) и
минимизирует невязку методом Левенберга–Марквардта (`scipy.optimize.least_squares`).
Ограничения задаются так:
- \( f_k \in [f_k^{\text{min}}, f_k^{\text{max}}] \), где границы берутся либо из
  конфигурации, либо из теории (±5 ГГц).
- \( \tau_k \in [0.8\,\tau_k^{(0)}, 1.2\,\tau_k^{(0)}] \) для теоретических оценок и
  в широком диапазоне при их отсутствии.

Ковариационная матрица параметров оценивается по формуле
\( \Sigma = (J^T J)^{-1} \sigma^2 \), где `J` — матрица Якоби, `σ` — дисперсия
остатков. Итоговые неопределённости выводятся как стандартные отклонения.

### 2.5. Критерии отбора результата
Стоимость определяется как взвешенная сумма квадратов невязки, нормированная на
энергию сигнала. Комбинации, дающие стоимость выше `MAX_COST`, отбрасываются.
При равных стоимостях предпочтение отдаётся кандидатам, ближе всего к теории и
имеющим меньшие ошибки оценок.

## Глава 3. Функции и их взаимодействие
Ниже перечислены ключевые функции и модули.

### 3.1. CLI и управление
- `spectral_pipeline.cli.main` — точка входа, orchestrator.
- `spectral_pipeline.cli.export_freq_tables` — экспорт Excel.
- `find_freqs_and_visualize.py` — обёртка для запуска из корня репозитория.

### 3.2. Загрузка и подготовка данных (`spectral_pipeline.io`)
- `load_records(path)` — чтение файлов, группировка, построение `DataSet`.
- `_load_guess(path)` — чтение пятистрочного теоретического файла.
- `resample_signal(record)` — унификация временной сетки.

### 3.3. Подбор частот и времен (`spectral_pipeline.fit`)
- `process_pair(dataset)` — основной цикл обработки LF/HF пары.
- `_esprit_freqs_and_decay(signal)` — ESPRIT‑оценка частоты/затухания.
- `_search_candidates(dataset, esprit_results)` — фильтрация кандидатов.
- `_fallback_peak(signal, range)` — резервный FFT/AR/Welch поиск.
- `fit_pair(signal, candidates)` — нелинейная аппроксимация двухтональной модели.
- `process_lf_only(dataset)` — вариант без HF данных.

### 3.4. Визуализация (`spectral_pipeline.plotting`)
- `visualize_stacked(results, spectra=True)` — полный отчёт со спектрами.
- `visualize_without_spectra(results)` — облегчённый отчёт.
- `_load_guess_curves(path)` — чтение теоретических кривых (частоты и τ).
- `_add_tau_trace(fig, axis)` — построение графиков времен затухания.

### 3.5. Тесты (`tests`)
Набор PyTest‑тестов проверяет корректность фильтрации HF, соблюдение границ
частот, устойчивость стоимости и подсчёт успешных аппроксимаций.

## Дополнительные разделы

### Структура данных
- `DataSet` содержит:
  - `lf_signal`, `hf_signal` — нормализованные временные ряды;
  - `initial_guess.freq_lf/hf`, `initial_guess.tau_lf/hf` — теоретические оценки;
  - `result` — экземпляр `FittingResult`.
- `FittingResult` хранит частоты, времена затухания, амплитуды, фазы,
  доверительные интервалы и стоимость подгонки.

### Визуализация
Графики строятся в три строки: частоты, времена затухания (в наносекундах) и
амплитуды. Теоретические кривые отображаются поверх экспериментальных точек,
если данные присутствуют. Спектральные диаграммы (при включённом режиме) показывают
модули FFT и найденные пики.

### Прочие компоненты
- Константы диапазонов и допусков собраны в `spectral_pipeline.constants`.
- Логирование выполняется через стандартный модуль `logging` с уровнями INFO,
  DEBUG и WARNING для контроля процесса.
- Обработка ошибок реализована через перехват исключений в `process_pair`, что
  позволяет продолжить обработку остальных наборов.

## Заключение
Документированные выше алгоритмы и функции образуют комплексную систему
аппроксимации спектров, устойчивую к шумам и неполноте данных. Использование
теоретических оценок для частот и времен затухания обеспечивает согласованность
результатов и ускоряет сходимость аппроксимации.
