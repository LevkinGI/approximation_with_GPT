# Spectral Approximation Pipeline

## Назначение
Программа автоматизирует обработку оптических сигналов, снятых в двух
диапазонах частот (LF и HF). Для каждой пары температур и магнитных полей она
определяет резонансные частоты и времена затухания, используя комбинацию
частотных оценок и нелинейной аппроксимации сигналов, а затем формирует
визуализации и экспортирует таблицы результатов.

## Структура данных
- **`spectral_pipeline.io.load_records`** считывает *.dat* файлы, нормализует
  временную ось, обрезает сигнал после первого минимума и создаёт объекты
  `DataSet`.
- `DataSet` хранит исходный временной ряд, предварительные оценки частот и
  времен затухания, а также результат аппроксимации (`FittingResult`).
- При наличии файлов первого приближения (`H_<H>.npy` или `T_<T>.npy`)
  `spectral_pipeline.fit._load_guess` извлекает как частоты, так и времена
  затухания (в нс) и конвертирует их в секунды.

## Алгоритм обработки пары LF/HF
1. **Подготовка сигналов** (`process_pair`):
   - Приведение LF и HF сигналов к общей сетке и удаление среднего.
   - Если имеются теоретические оценки, они сохраняются в набор данных и
     используются как частотные и временные фильтры.
2. **Поиск кандидатов**:
   - Вычисление грубых оценок (`_single_sine_refine`) и спектров методом
     многоступенчатого ESPRIT (`multichannel_esprit`).
   - Фильтрация по диапазону частот и отклонению от теоретических времен
     затухания (допуск 20%).
   - При отсутствии кандидатов запускается резервный поиск `_fallback_peak`,
     который комбинирует Burg AR, Welch и усреднённый FFT.
3. **FFT-контроль**: `_fft_spectrum` вычисляет спектры обеих полос, а
   `_peak_in_band` проверяет наличие пиков в ожидаемых диапазонах и при
   необходимости расширяет их.
4. **Нелинейная аппроксимация** (`fit_pair`):
   - Строится модель из двух затухающих косинусоид.
   - Используется `scipy.optimize.least_squares` с ограничениями по частотам и
     временам затухания (±20% от теоретических значений, если они есть).
   - Весовая функция уменьшает вклад хвоста сигнала, чтобы устойчиво оценивать
     начальный участок.
   - После сходимости вычисляются ковариации и неопределённости частот.
5. **Выбор лучшего результата**: Перебор комбинаций кандидатов, отсев по
   ограничению стоимости (`MAX_COST`) и фиксация лучшего `FittingResult`.

## Обработка только LF сигнала
Функция `process_lf_only` выполняет аналогичные шаги, но формирует HF
кандидатов по остаточному сигналу. Если теоретическая вторая частота недоступна,
диапазоны поиска расширяются симметрично.

## Использование теоретических данных
- Частоты и времена затухания из файлов первого приближения используются при
  фильтрации кандидатов и задают интервалы оптимизации (±5 ГГц по частоте,
  ±20% по времени).
- Функция `_load_guess_curves` в `plotting.py` считывает те же данные для
  построения теоретических кривых на графиках.

## Визуализация
`spectral_pipeline.plotting` предоставляет два режима:
1. `visualize_stacked` — совмещённые графики сигналов, спектров, частот, времен
   затухания и амплитуд с возможностью сохранения HTML.
2. `visualize_without_spectra` — компактный отчёт без спектров, но с ошибками
   частот.
Оба варианта рисуют экспериментальные точки, результаты подгонки и, при
наличии, теоретические зависимости.

## Экспорт результатов
`spectral_pipeline.cli.export_freq_tables` собирает оценённые частоты в матрицы
«температура × поле» и сохраняет их в Excel. Основная функция `main`
координирует весь процесс: загрузка, группировка пар LF/HF, вызов обработки,
визуализация и экспорт.

## Программные зависимости
- NumPy, SciPy — расчёты спектров, оптимизация и линейная алгебра.
- Plotly — интерактивные визуализации.
- Pandas и openpyxl — экспорт таблиц в Excel.

## Резервные механизмы
- Отбрасывание компонент ESPRIT с отрицательным временем затухания.
- Многоступенчатый поиск пиков с расширением диапазона.
- Разрешённое использование только LF-данных, если HF отсутствует или
  эксперимент вышел за точку пересечения мод.

Эти элементы обеспечивают устойчивую работу программы на реальных измерениях,
даже при наличии шумов и неполных данных.
